# Coolify Configuration for CoderBot v2
# This file contains Coolify-specific deployment settings

# Docker Configuration
image: coderbot-v2
context: .
dockerfile: Dockerfile

# Ports Configuration
ports:
  - source: 8000
    target: 8000
    protocol: tcp
    description: "Backend API"
  - source: 8090 
    target: 8090
    protocol: tcp
    description: "PocketBase Database"
  - source: 3000
    target: 3000
    protocol: tcp
    description: "Frontend (Optional)"
  - source: 8080
    target: 8080
    protocol: tcp
    description: "Code-Server IDE"

# Environment Variables
environment:
  # Required - AI API Configuration
  DEEP_SEEK_API_KEY: "${DEEP_SEEK_API_KEY}"
  DEEP_SEEK_API_URL: "${DEEP_SEEK_API_URL:-https://api.deepseek.com/v1}"
  OPEN_AI_API_KEY: "${OPEN_AI_API_KEY}"
  OPENAI_API_URL: "${OPENAI_API_URL:-https://api.openai.com/v1}"
  CLAUDE_API_KEY: "${CLAUDE_API_KEY}"
  RAPIDAPI_KEY: "${RAPIDAPI_KEY}"
  
  # PocketBase Configuration
  POCKETBASE_URL: "http://localhost:8090"
  POCKETBASE_ADMIN_EMAIL: "${POCKETBASE_ADMIN_EMAIL:-admin@coderbot.dev}"
  POCKETBASE_ADMIN_PASSWORD: "${POCKETBASE_ADMIN_PASSWORD}"
  POCKETBASE_USER_EMAIL: "${POCKETBASE_USER_EMAIL:-user@coderbot.dev}"
  POCKETBASE_USER_PASSWORD: "${POCKETBASE_USER_PASSWORD}"
  
  # Optional - Supabase Integration
  SUPABASE_URL: "${SUPABASE_URL}"
  SUPABASE_KEY: "${SUPABASE_KEY}"
  
  # Runtime Configuration
  PYTHONUNBUFFERED: "1"
  NODE_ENV: "production"
  
  # Code-Server Configuration
  CODE_SERVER_PASSWORD: "${CODE_SERVER_PASSWORD:-coderbot2024}"

# Health Check Configuration
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s

# Volume Configuration
volumes:
  - type: volume
    source: coderbot_pocketbase_data
    target: /app/data/pb_data
    description: "PocketBase Database Storage"
  - type: volume
    source: coderbot_code_server_data
    target: /app/data/code-server
    description: "Code-Server Configuration and Extensions"
  - type: volume
    source: coderbot_workspace_data
    target: /app/workspace
    description: "Development Workspace Files"
  - type: volume
    source: coderbot_logs
    target: /app/logs
    description: "Application Logs"

# Resource Limits
resources:
  limits:
    memory: 2G
    cpus: "1.0"
  reservations:
    memory: 1G
    cpus: "0.5"

# Restart Policy
restart_policy:
  condition: unless-stopped
  delay: 5s
  max_attempts: 3

# Networks
networks:
  - coderbot_network

# Labels for Coolify
labels:
  - "coolify.managed=true"
  - "coolify.service=coderbot-v2"
  - "coolify.version=2.0.0"
  - "coolify.category=educational-platform"
